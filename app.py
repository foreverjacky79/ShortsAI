import streamlit as st
import requests
import pandas as pd
from datetime import datetime, timedelta, timezone
from googleapiclient.discovery import build
import google.generativeai as genai
import re

# é…ç½®
st.set_page_config(layout="wide", page_icon="ðŸŽ¥", page_title="YouTube Shorts åˆ†æžå·¥å…·")

@st.cache_data(ttl=300)
# == search YT and create prompt ==
def fetch_trending_shorts(api_key, keyword, days, min_views, max_results, min_viral_score, max_duration):
    """YouTube Shorts è¶¨å‹¢æœå°‹ï¼ˆç„¡ yt_dlpï¼‰"""
    youtube = build("youtube", "v3", developerKey=api_key)
    published_after = (datetime.now(timezone.utc) - timedelta(days=days)).strftime("%Y-%m-%dT%H:%M:%SZ")

    # åªæœçŸ­å½±ç‰‡
    search_response = youtube.search().list(
        q=f"{keyword} shorts", 
        part="id,snippet", 
        type="video", 
        order="viewCount", 
        maxResults=max_results, 
        videoDuration="short",
        publishedAfter=published_after
    ).execute()

    video_ids = [item["id"]["videoId"] for item in search_response["items"] if item["id"]["videoId"]]
    if not video_ids: return []

    # è©³ç´°è³‡æ–™
    video_response = youtube.videos().list(
        part="snippet,statistics,contentDetails", 
        id=",".join(video_ids[:50])
    ).execute()

    results = []
    for item in video_response.get("items", []):
        duration_raw = item["contentDetails"]["duration"]
        total_seconds = parse_duration_to_seconds(duration_raw)
        if total_seconds > max_duration: continue

        stats = item.get("statistics", {})
        snippet = item["snippet"]
        views = int(stats.get("viewCount", 0))
        if views < min_views: continue

        published = datetime.fromisoformat(snippet["publishedAt"].replace("Z", "+00:00"))
        now = datetime.now(timezone.utc)
        hours_passed = max((now - published).total_seconds() / 3600, 1)
        viral_score = views / hours_passed
        
        if viral_score < min_viral_score: continue

        m, s = divmod(total_seconds, 60)
        results.append({
            "title": snippet["title"][:80],
            "views": views,
            "duration": f"{m}:{s:02d}",
            "hours": round(hours_passed, 1),
            "viral_score": round(viral_score, 2),
            "published": published.strftime("%m-%d %H:%M"),
            "url": f"https://youtube.com/watch?v={item['id']}"
        })
    
    return sorted(results, key=lambda x: x["viral_score"], reverse=True)

def parse_duration_to_seconds(duration_str):
    h = re.search(r'(\d+)H', duration_str)
    m = re.search(r'(\d+)M', duration_str)
    s = re.search(r'(\d+)S', duration_str)
    return (int(h.group(1)) if h else 0)*3600 + (int(m.group(1)) if m else 0)*60 + (int(s.group(1)) if s else 0)

def ai_generate_prompt(gemini_api_key, video_url):
    """ç´”æ–‡å­— AI Prompt ç”Ÿæˆ"""
    try:
        genai.configure(api_key=gemini_api_key)
        model = genai.GenerativeModel('gemini-1.5-flash')
        prompt = f"""Create detailed English prompt for AI video generation recreating YouTube Shorts: {video_url}

Essential elements:
â€¢ Main character description (appearance, clothing, expression)
â€¢ Specific actions/movements  
â€¢ Environment/setting details
â€¢ Camera movements (zoom, pan, close-up)
â€¢ Lighting and color atmosphere
â€¢ 15-30 second duration suggestion

Single paragraph, optimized for Sora/Runway/RunwayML."""
        
        response = model.generate_content(prompt)
        return response.text
    except Exception as e:
        return f"âŒ Gemini API éœ€è¦è¨­å®š\néŒ¯èª¤: {str(e)}"

# == current version ==
@st.cache_data(ttl=3600)
def get_current_version():
    try:
        return requests.get("https://raw.githubusercontent.com/foreverjacky79/ShortsAI/refs/heads/main/version.txt", timeout=5).text.strip()
    except:
        return "1.0.5"

version = get_current_version()

# ===== ç¾Žè§€ Title + ç‰ˆæœ¬ï¼ˆæ›¿æ›ä½ çš„ st.markdownï¼‰=====
# Title + ç‰ˆè™Ÿï¼ˆå¾€ä¸‹ç§»ç‰ˆè™Ÿï¼‰
st.title("ðŸŽ¥ YouTube Shorts è¶¨å‹¢åˆ†æžå·¥å…·")
st.markdown(" ")  
st.caption(f"**v{version}**")

# == Sidebar ==
st.sidebar.header("ðŸ”‘ API é‡‘é‘°")
api_key = st.sidebar.text_input("YouTube API Key", type="password", 
                               help="console.cloud.google.com â†’ YouTube Data API v3")
gemini_key = st.sidebar.text_input("Gemini API Key", type="password", 
                                  help="aistudio.google.com/app/apikey")

st.sidebar.header("ðŸ” æœå°‹è¨­å®š")
col1, col2 = st.sidebar.columns(2)
keyword = col1.text_input("é—œéµå­—", value="animal")
days = col2.number_input("æœ€è¿‘å¤©æ•¸", 1, 14, 7)

col3, col4 = st.sidebar.columns(2)
min_views = col3.number_input("æœ€ä½Žè§€çœ‹æ•¸", 10000, 1000000, 50000)
max_duration = col4.number_input("æœ€é•·ç§’æ•¸", 0, 60, 20)

col5, col6 = st.sidebar.columns(2)
min_viral = col5.number_input("æœ€ä½Žçˆ†ç™¼æŒ‡æ•¸", 500.0, 10000.0, 3000.0)
max_results = col6.number_input("æœ€å¤§çµæžœ", 20, 100, 50)

# æœå°‹æŒ‰éˆ•
if st.sidebar.button("ðŸš€ é–‹å§‹åˆ†æž", type="primary", use_container_width=True):
    if not api_key:
        st.sidebar.error("âŒ éœ€è¦ YouTube API Key")
        st.stop()
    with st.spinner("ðŸ” æœå°‹ç†±é–€ Shorts ä¸­..."):
        results = fetch_trending_shorts(api_key, keyword, days, min_views, max_results, min_viral, max_duration)
        st.session_state.results = results
        if results:
            st.success(f"âœ… æ‰¾åˆ° {len(results)} å€‹ç¬¦åˆæ¢ä»¶çš„ç†±é–€å½±ç‰‡ï¼")
        else:
            st.warning("âš ï¸ æœªæ‰¾åˆ°ç¬¦åˆæ¢ä»¶çš„å½±ç‰‡ï¼Œè«‹èª¿æ•´æœå°‹æ¢ä»¶")
        st.rerun()

# çµæžœå±•ç¤º
if "results" in st.session_state and st.session_state.results:
    df = pd.DataFrame(st.session_state.results)
    
    st.markdown(f"## ðŸ“Š æœå°‹çµæžœ ({len(df)} ç­†)")
    
    # é¸æ“‡å™¨
    selected_idx = st.selectbox(
        "ðŸŽ¯ é¸æ“‡å½±ç‰‡åˆ†æžï¼š",
        range(len(df)),
        format_func=lambda i: f"ðŸ”¥ {df.iloc[i]['title'][:60]}... | {df.iloc[i]['views']:,}è§€çœ‹ | çˆ†ç™¼æŒ‡æ•¸ {df.iloc[i]['viral_score']:.0f}"
    )
    
    selected = df.iloc[selected_idx]
    
    # è³‡è¨Šå¡ç‰‡
    col1, col2, col3 = st.columns(3)
    col1.metric("ðŸ‘€ è§€çœ‹æ•¸", f"{selected['views']:,}", f"{selected['viral_score']:.0f}")
    col2.metric("â±ï¸ æ™‚é•·", selected['duration'])
    col3.metric("ðŸ• ç™¼å¸ƒ", f"{selected['hours']}å°æ™‚å‰")
    
    st.markdown(f"**{selected['title']}**")
    st.markdown(f"[ðŸ”— è§€çœ‹åŽŸå½±ç‰‡]({selected['url']})")
    
    # å‹•ä½œåˆ—
    col1, col2 = st.columns(2)
    if col1.button("ðŸ¤– ç”Ÿæˆ AI Prompt", type="primary", use_container_width=True, disabled=not gemini_key):
        if gemini_key:
            with st.spinner("ðŸŽ¨ AI ç”Ÿæˆä¸­..."):
                result = ai_generate_prompt(gemini_key, selected['url'])
                st.session_state.ai_result = result
                st.success("âœ… AI Prompt ç”Ÿæˆå®Œæˆï¼")
    
    # å®Œæ•´è¡¨æ ¼
    st.markdown("### ðŸ“‹ å®Œæ•´æœå°‹çµæžœ")
    st.dataframe(
        df[['title', 'views', 'viral_score', 'duration', 'published']],
        use_container_width=True,
        column_config={
            "views": st.column_config.NumberColumn("è§€çœ‹æ•¸", format="%,d"),
            "viral_score": st.column_config.NumberColumn("çˆ†ç™¼æŒ‡æ•¸", format="%.1f")
        },
        hide_index=True
    )

# AI Prompt çµæžœ
if "ai_result" in st.session_state:
    st.markdown("## ðŸŽ¨ AI ç”Ÿæˆçš„å½±ç‰‡ Prompt")
    st.code(st.session_state.ai_result, language=None)
    
    col1, col2 = st.columns(2)
    with col1:
        st.download_button(
            "ðŸ’¾ ä¸‹è¼‰ Prompt.txt",
            data=st.session_state.ai_result,
            file_name="youtube_shorts_ai_prompt.txt",
            mime="text/plain"
        )
    with col2:
        st.markdown("### ðŸ“‹ ç›´æŽ¥è¤‡è£½")
        st.code(st.session_state.ai_result)

# ä½¿ç”¨èªªæ˜Ž
with st.expander("ðŸ“– ä½¿ç”¨èªªæ˜Ž & API ç”³è«‹"):
    st.markdown("""
    ### ðŸš€ å¿«é€Ÿä¸Šæ‰‹
    1. **å´é‚Šæ¬„**å¡«å…¥ **YouTube API Key**
    2. èª¿æ•´æœå°‹æ¢ä»¶ â†’ **é–‹å§‹åˆ†æž**
    3. é¸æ“‡ç†±é–€å½±ç‰‡ â†’ **ç”Ÿæˆ AI Prompt**
    4. è¤‡è£½ Prompt åˆ° **Sora/Runway/Kling** ç­‰ AI å·¥å…·
    
    ### ðŸ”‘ API Key ç”³è«‹
    **YouTube Data API v3**ï¼ˆå…è²»ï¼Œæ¯æ—¥10,000æ¬¡ï¼‰ï¼š
    1. [Google Cloud Console](https://console.cloud.google.com)
    2. æ–°å»ºå°ˆæ¡ˆ â†’ å•Ÿç”¨ **YouTube Data API v3**
    3. æ†‘è­‰ â†’ **API Key** â†’ è¤‡è£½
    
    **Gemini API**ï¼ˆå…è²»ï¼Œæ¯åˆ†é˜15æ¬¡ï¼‰ï¼š
    1. [Google AI Studio](https://aistudio.google.com/app/apikey)
    2. **Get API Key** â†’ è¤‡è£½
    
    ### ðŸ’¡ æœå°‹æŠ€å·§
    - **é—œéµå­—**ï¼š`cat` `dog` `cooking` `dance`
    - **å¤©æ•¸**ï¼š1-3å¤©æœ€ç†±é–€ï¼Œ7å¤©è¼ƒå…¨é¢
    - **çˆ†ç™¼æŒ‡æ•¸**ï¼š2000+ = ç—…æ¯’å¼å‚³æ’­
    """)
